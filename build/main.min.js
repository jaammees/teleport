var g_scene=null;var g_vrMode=-1;var energyDiv=null;var ENERGY_MAX=8;var mouseDownCount=0;AFRAME.registerComponent("game",{init:function(){g_scene=document.querySelector("a-scene");energyDiv=document.createElement("div");energyDiv.setAttribute("id","infoPanel");energyDiv.setAttribute("style","position: absolute; top: 0; left: 0; right: 0; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center;  color: white; font-family: arial, helvetica, sans-serif");var e="";e+='<div style="display: flex; margin-bottom: 6px">';e+='<div style="margin-right: 6px; display: flex; align-items: center">Energy</div>';e+='<div style="display: flex; align-items: center">';for(var t=0;t<8;t++){e+='<div id="energy_'+t+'" style="width: 16px; height: 16px; background-color: #0f0; margin-right: 4px"></div>'}e+="</div>";e+='<div id="restart-button" style="display: flex; align-items: center; margin-left: 8px; cursor: pointer; height: 20px; color: #eee; background-color: #333; padding: 6px">Restart Level</div>';e+="</div>";e+='<div style="display: flex" id="instructions"></div>';energyDiv.innerHTML=e;document.body.appendChild(energyDiv);document.getElementById("restart-button").addEventListener("click",function(e){g_playfield.restartLevel()});g_playfield=new Playfield;g_playfield.init();g_sound=new Sound;document.addEventListener("mousedown",function(e){if(!g_vrMode){if(mouseDownCount==0){mouseDownCount++;g_playfield.buttonDown(e)}}});document.addEventListener("mouseup",function(e){if(!g_vrMode){if(mouseDownCount>0){mouseDownCount--}g_playfield.buttonUp(e)}})},tick:function(e,t){if(g_scene.is("vr-mode")){if(g_vrMode===false||g_vrMode===-1){g_vrMode=true;energyDiv.style.display="none";g_playfield.modeChange()}}else{if(g_vrMode===true||g_vrMode===-1){g_vrMode=false;energyDiv.style.display="flex";g_playfield.modeChange()}}if(g_playfield==null){}while(t>0){var r=40;if(r>t){r=t}t-=r;g_playfield.tick(e,r)}}});var g_startLevel=2;var g_playfield=null;var g_playfieldScale=1;var g_raycaster=null;var g_leftButtonDownCount=0;var g_rightButtonDownCount=0;var STATE_LEVEL_PREVIEW=0;var STATE_PLAYING=1;var STATE_IN_TELEPORT=2;var STATE_LEVEL_FINISHED=3;var STATE_TELEPORT_NEXT=4;var Playfield=function(){var o=0;var l=false;var s=true;var u=false;var c=false;var f=false;var v=false;var d=false;var E=this;var e=-1;var g=null;var b=STATE_LEVEL_PREVIEW;var p=new THREE.Vector3;var A=new THREE.Vector3;var a=0;var n=0;var y=0;var m=0;var T=null;var i=null;var _=false;var h=false;var D=null;var w=null;var R=null;var P=null;var S=[];var V=[];var L=null;var I=null;var x=null;var t=new THREE.Vector3;var M=new THREE.Vector3;var k=null;var O=null;var N=null;var H=null;var B=null;var C=null;var j=null;var z=null;var G=[];var U=[];var X=false;var Y=false;var W=g_scene.object3D;var q=new THREE.Vector3;var F=new THREE.Vector3;var K=false;var Z=new THREE.Vector3;var J=new THREE.Vector3(0,0,0);var Q=0;E.setEnergyFromTo=function(e,t){q.set(e.x,e.y+.3,e.z);F.set(t.x,t.y,t.z)};E.setEnergyTransferring=function(e){K=e};E.updateEnergyBlocks=function(e,t){for(var r=0;r<G.length;r++){if(G[r].mesh.visible){var a=G[r].mesh;Z.set(F.x-a.position.x,F.y-a.position.y,F.z-a.position.z);var n=J.distanceTo(Z);Z.normalize();var i=t*.01;if(i>n){i=n}if(i<.001){a.visible=false}else{a.position.set(a.position.x+i*Z.x,a.position.y+i*Z.y,a.position.z+i*Z.z)}}}if(K){if(e-Q>80){for(var r=0;r<G.length;r++){if(G[r].mesh.visible==false){G[r].mesh.visible=true;G[r].mesh.position.set(q.x+Math.random()*.2,q.y+Math.random()*.3,q.z+Math.random()*.2);break}}Q=e}}};function $(){L=document.createElement("a-entity");L.setAttribute("class","non-removable");var e=new THREE.ConeGeometry(.4,1.8,3);var t=new THREE.MeshStandardMaterial({color:16776960,transparent:true});t.flatShading=true;var r=new THREE.Mesh(e,t);r.position.set(0,.9,0);L.setObject3D("mesh",r);var a=new THREE.IcosahedronGeometry(.4,1);var n=new THREE.Mesh(a,t);n.position.set(0,.7,0);r.add(n);var i=document.createElement("a-triangle");i.setAttribute("color","#eee");i.setAttribute("rotation","0 270 90");i.setAttribute("side","double");i.setAttribute("scale","0.2 0.26 0.2");i.setAttribute("position","0 1.65 -0.7");L.append(i);var o=document.createElement("a-text");o.setAttribute("value","Start Position");o.setAttribute("scale","3 3 3");o.setAttribute("side","double");o.setAttribute("color","#fff");o.setAttribute("position","0 2.5 2");o.setAttribute("rotation","0 90 0");L.append(o);x=document.getElementById("player-collision-box");C.append(L)}function ee(){k=document.createElement("a-entity");k.setAttribute("class","non-removable");N=new Exit(k);O=document.createElement("a-text");O.setAttribute("value","Exit");O.setAttribute("scale","3 3 3");O.setAttribute("side","double");O.setAttribute("color","#fff");O.setAttribute("position","0 2.5 0.6");O.setAttribute("rotation","0 90 0");k.append(O);C.append(k)}E.showEnergy=function(){var e=g.getEnergy();for(var t=0;t<ENERGY_MAX;t++){var r=document.getElementById("energy_"+t);if(t<e){r.style.backgroundColor="#0f0"}else{r.style.backgroundColor="#111"}}for(var t=0;t<U.length;t++){U[t].setEnergy(e)}};function te(e,t){if(e-m>2){r()}}function r(){o++;if(o>=g_levels.length){o=0}E.gotoLevel(o)}E.buildCollisionObjectList=function(){V=[];for(var e=0;e<S.length;e++){if(S[e].getIsSolid()){var t=S[e].getObject();V.push(t)}}if(b==STATE_PLAYING){x.object3D.isPlayer=true;if(x.object3D.children.length>0){x.object3D.children[0].isPlayer=true;V.push(x.object3D.children[0])}V.push(x.object3D)}};E.getCollisionObjects=function(){return V};E.init=function(){g=new Player(this);I=document.getElementById("player-shadow");C=document.getElementById("playfield");z=document.getElementById("playfield-holder");H=document.getElementById("level-text");T=document.getElementById("camera");i=document.getElementById("camera-offset");j=document.getElementById("level-info");g_raycaster=new THREE.Raycaster;g_raycaster.near=0;g_raycaster.far=1e4;R=document.getElementById("laser-left");w=new InfoPanel(document.getElementById("left-info"));U.push(w);var e=new THREE.MeshStandardMaterial({color:6711039,transparent:true,opacity:.7});e.flatShading=true;var t=new THREE.BoxGeometry(.05,.05,.05);for(var r=0;r<30;r++){var a=new THREE.Mesh(t,e);G.push({mesh:a});W.add(a)}R.addEventListener("buttondown",function(e){X=y;w.setButtonDown(true);if(g_leftButtonDownCount==0){g_leftButtonDownCount++;E.buttonDown(e)}});R.addEventListener("buttonup",function(e){if(g_leftButtonDownCount>0){g_leftButtonDownCount--}w.setButtonDown(false);X=false;if(Y===false){v=false}E.buttonUp(e)});D=document.getElementById("laser-right");P=new InfoPanel(document.getElementById("right-info"));U.push(P);D.addEventListener("buttondown",function(e){Y=y;P.setButtonDown(true);if(g_rightButtonDownCount==0){g_rightButtonDownCount++;E.buttonDown(e)}});D.addEventListener("buttonup",function(e){if(g_rightButtonDownCount>0){g_rightButtonDownCount--}P.setButtonDown(false);Y=false;if(X===false){v=false}E.buttonUp(e)});B=new StartButton(this);E.gotoLevel(g_startLevel)};E.buttonDown=function(e){for(var t=0;t<S.length;t++){S[t].buttonDown(e)}};E.buttonUp=function(e){for(var t=0;t<S.length;t++){S[t].buttonUp(e)}};E.clearLevel=function(){for(var e=0;e<S.length;e++){S[e].cleanup()}S=[];while(C.children.length>0){var t=false;for(var e=0;e<C.children.length;e++){if(C.children[e].getAttribute("class")!=="non-removable"){t=e;break}}if(t===false){break}else{C.removeChild(C.children[t])}}};E.setControllerInfoVisible=function(e){document.getElementById("left-info").object3D.visible=e;document.getElementById("right-info").object3D.visible=e};var re=function(){document.getElementById("instructions").innerHTML=""};var ae=function(){var e="";for(var t=0;t<4;t++){var r="";if(t<g_levels[o].text.length){r=g_levels[o].text[t]}e+=" "+r;w.setText(t,r);P.setText(t,r)}document.getElementById("instructions").innerHTML=e;speak(e)};E.modeChange=function(){if(g_vrMode){E.setControllerInfoVisible(true);I.object3D.visible=false}else{E.setControllerInfoVisible(false);I.object3D.visible=true}if(b==STATE_LEVEL_PREVIEW){ne()}};E.restartLevel=function(){E.gotoLevel(o)};function ne(){if(g_vrMode){C.setAttribute("position",new THREE.Vector3(-a*g_playfieldScale,1,n*g_playfieldScale));j.setAttribute("position","0 0 -0.5")}else{C.setAttribute("position",new THREE.Vector3(-a*g_playfieldScale,1.4,n*g_playfieldScale));j.setAttribute("position","0 -0 0")}}E.gotoLevel=function(e){re();E.clearLevel();o=e;b=STATE_LEVEL_PREVIEW;for(var t=0;t<4;t++){w.setText(t,"");P.setText(t,"")}var r=e+1;H.setAttribute("value","Level "+r);E.build();n=(A.z+p.z)/2;a=(A.x+p.x)/2;g_playfieldScale=.08;ne();C.setAttribute("scale",new THREE.Vector3(g_playfieldScale,g_playfieldScale,g_playfieldScale));C.setAttribute("rotation","0 180 0");g.setPosition(-1.2,0,0,0,-90,0);ie();if(!g_vrMode||g_vrMode===-1){T.setAttribute("look-controls",false);T.setAttribute("wasd-controls",false);T.object3D.rotation.set(0,0,0);T.setAttribute("rotation","0 0 0");T.setAttribute("look-controls",true);T.setAttribute("wasd-controls",true);T.components["look-controls"].pitchObject.rotation.x=0;T.components["look-controls"].yawObject.rotation.y=0}B.show();L.object3D.visible=true;H.object3D.visible=true;O.object3D.visible=true};E.getGameState=function(){return b};function ie(){_=-T.object3D.position.x;h=-T.object3D.position.z;i.object3D.position.setX(_);i.object3D.position.setZ(h)}E.startLevel=function(){for(var e=0;e<S.length;e++){S[e].setClickable(true)}var r=0;g.startTeleport(M.x,M.y,M.z,0,0,0,function(e,t){L.object3D.visible=false;O.object3D.visible=false;ie();g.setPosition(M.x,M.y,M.z,0,r,0);if(e=="arrived"){C.setAttribute("position",new THREE.Vector3(0,0,0));C.setAttribute("rotation","0 0 0");g_playfieldScale=1;C.setAttribute("scale","1 1 1");H.object3D.visible=false;B.hide();ae()}});b=STATE_PLAYING;s=true};E.build=function(){p.x=1e4;p.y=1e4;p.z=1e4;A.x=-1e4;A.y=-1e4;A.z=-1e4;var e=g_levels[o].data;var t=g_levels[o].startRotation;rotationSpeed=70;if(typeof g_levels[o].robotSpeed!="undefined"){rotationSpeed=g_levels[o].robotSpeed}for(var r=0;r<e.length;r++){var a=e[r][0];var n=S.length;var i=new Pad(E,C,n,a);C.append(i.getEntity());p.x=Math.min(p.x,e[r][1]);p.y=Math.min(p.y,e[r][2]);p.z=Math.min(p.z,e[r][3]);A.x=Math.max(A.x,e[r][1]);A.y=Math.max(A.y,e[r][2]);A.z=Math.max(A.z,e[r][3]);i.setPosition(e[r][1],e[r][2],e[r][3]);i.setRotation(e[r][4],e[r][5],e[r][6]);i.setClickable(false);S.push(i);g.setEnergy(g_levels[o].energy);if(a==START_PAD){if(L==null){$()}L.setAttribute("position",new THREE.Vector3(e[r][1],e[r][2],e[r][3]));L.setAttribute("rotation",new THREE.Vector3(0,t,0));M.set(e[r][1],e[r][2],e[r][3]);l=n}if(a==2){if(k==null){ee()}k.setAttribute("position",new THREE.Vector3(e[r][1],e[r][2],e[r][3]))}}V=[]};E.getCurrentPadIndex=function(){return l};E.getOnPad=function(){return s};E.noEnergy=function(){w.setText(0,"No Energy");w.setText(1,"Hold button for 1 second");w.setText(2,"to restart level");w.setText(3,"");P.setText(0,"No Energy");P.setText(1,"Hold button for 1 second");P.setText(2,"to restart level");P.setText(3,"")};E.teleportPlayer=function(e,t,r,a,n,i,o,s){console.error("player enery = ");console.log(g.getEnergy());if(g.getEnergy()==0){if(g_vrMode){speak("No energy to teleport, hold the button for one second to restart")}else{speak("No energy to teleport")}return}g_sound.playSound(SOUND_EXIT);b=STATE_IN_TELEPORT;g.startTeleport(e,t,r,a,n,o,function(e,t){l=i;ie();for(var r=0;r<S.length;r++){S[r].playerTeleported(i,t)}if(typeof s!="undefined"){s()}if(e=="finished"){b=STATE_PLAYING;if(t==2){b=STATE_LEVEL_FINISHED}}});g.decreaseEnergy(o!==EXIT_PAD)};E.getPlayerPosition=function(){x.object3D.getWorldPosition(t);return t};E.getPlayer=function(){return g};E.increasePlayerEnergy=function(){g.increaseEnergy()};E.decreasePlayerEnergy=function(){g.decreaseEnergy()};E.gameOver=function(){speak("Game Over")};E.tick=function(e,t){if(b==STATE_LEVEL_PREVIEW){}if(b==STATE_LEVEL_FINISHED){if(e-m>800){b=STATE_TELEPORT_NEXT;m=e}}if(b==STATE_TELEPORT_NEXT){te(e,t)}E.buildCollisionObjectList();for(var r=0;r<S.length;r++){S[r].tick(e,t)}var a=T.object3D.position;I.object3D.position.setX(a.x+_);I.object3D.position.setZ(a.z+h);x.object3D.position.setX(a.x+_);x.object3D.position.setZ(a.z+h);x.object3D.position.setY(a.y-.24);if(b==STATE_PLAYING){var n=Math.sqrt((a.x+_)*(a.x+_)+(a.z+h)*(a.z+h));if(X!==false||Y!==false){var i=false;for(var r=0;r<S.length;r++){if(S[r].getInAbsorb()){i=true;break}}if(i){if(X!==false){X=e}if(Y!==false){Y=e}}}if(X!==false&&e-X>1200||Y!==false&&e-Y>2e3){if(!i){if(!v){speak("Button held for one second, the level will restart in three");v=true;d=e;f=3}if(f==3&&e-d>4600){speak("two");f--}if(f==2&&e-d>5400){speak("one");f--}if(f==1&&e-d>6200){speak("level restart");E.gotoLevel(o)}}}else{v=false}if(n>1.5){if(s){s=false;u=e;c=false;f=3}if(e-u>400&&!c){speak("You are not on your pad, the level will restart in three");c=true;f=3;u=e+3e3}if(c){if(f==3&&e-u>1e3){speak("two");f--;u=e}if(f==2&&e-u>1e3){speak("one");f--;u=e}if(f==1&&e-u>1600){speak("level restart");E.gotoLevel(o)}}}else{if(s===false){speak("You are back on your pad")}s=true;c=false}}y=e;g.tick(e,t);N.tick(e,t);E.updateEnergyBlocks(e,t)}};var Player=function(t){var r=this;var s=document.getElementById("player");var T=document.getElementById("camera");var _=[];var l=new THREE.Vector3;var u=new THREE.Vector3;var c=false;var f=false;var v=false;var a=0;var d=false;var E=0;var g=8;var e=function(){var e;var t=10;for(e=0;e<t;e++){var r=e*360/t;var a=.07;var n=-Math.sin(r*2*Math.PI/360)*a;var i=-Math.cos(r*2*Math.PI/360)*a;var o=document.createElement("a-box");o.setAttribute("scale","0.05 0.04 0.001");o.setAttribute("color","#ffffff");if(e==0){o.setAttribute("color","#ffffff")}else if(e==1){o.setAttribute("color","#ff0000")}else if(e==2){o.setAttribute("color","#00ff00")}else if(e==3){o.setAttribute("color","#00ffff")}else{o.setAttribute("color","#ff00ff")}o.setAttribute("position",new THREE.Vector3(n,1.6,i));o.setAttribute("rotation",new THREE.Vector3(0,r,0));o.object3D.visible=false;s.append(o)}};var n=function(){var e=40;var t=1;var r=2*Math.PI*t;var a=r/e+.1;var n=0;var i=0;var o=0;var s=0;var l;var u;var c;var f=0;for(var v=0;v<e;v++){i=v*Math.PI*2/e;o=t*Math.cos(i);s=t*Math.sin(i);l=o;u=2*Math.PI*l;c=Math.round(u/a+.5);var d=[];for(var E=0;E<=c;E++){n=E*Math.PI*2/c;var g=l*Math.cos(n);var b=l*Math.sin(n);var p=document.createElement("a-plane");var A=a-.04+.15;var y=a-.1+.16;var m=.007;p.setAttribute("scale",new THREE.Vector3(A,y,m));p.setAttribute("color","#333333");p.setAttribute("material","side: double;shader: flat;");p.setAttribute("position",new THREE.Vector3(g,s+1,b));p.setAttribute("rotation",new THREE.Vector3(-(v*360/e),180/2-E*360/c,0));p.yPosition=s;p.object3D.visible=false;T.append(p);d.push(p);f++}if(d.length>0){_.push(d)}}_.sort(function(e,t){var r=e[0].yPosition-t[0].yPosition;return r})};r.getPosition=function(){return s.getAttribute("position")};r.getEnergy=function(){return g};r.increaseEnergy=function(){if(g<ENERGY_MAX){g++;t.showEnergy()}};r.decreaseEnergy=function(e){if(g>0){g--;t.showEnergy();if(g==0){if(typeof e==="undefined"||e===true){speak("Warning, zero energy")}t.noEnergy()}}else{t.gameOver()}};r.setEnergy=function(e){g=e;t.showEnergy()};r.startTeleport=function(e,t,r,a,n,i,o){if(g<=0){return}l.set(e,t,r);u.set(a,E,n);f=0;v=1;d=i;c=o};r.updateTeleport=function(){if(v===1){for(var e=0;e<_[f].length;e++){_[f][e].object3D.visible=true;_[f][e].setAttribute("color","#ffffff")}if(f>0){for(var e=0;e<_[f-1].length;e++){_[f-1][e].setAttribute("color","#cccccc")}}if(f>1){for(var e=0;e<_[f-1].length;e++){_[f-1][e].setAttribute("color","#aaaaaa")}}f++;if(f>=_.length){f=0;v=-1;r.moveToTeleport()}}else if(v===-1){for(var e=0;e<_[f].length;e++){_[f][e].object3D.visible=false;_[f][e].setAttribute("color","#ffffff")}f++;if(f>=_.length){v=false;if(typeof c!="undefined"){c("finished",d)}}}};r.setPosition=function(e,t,r,a,n,i){E=n;s.setAttribute("position",new THREE.Vector3(e,t,r));s.setAttribute("rotation",new THREE.Vector3(a,n,i))};r.moveToTeleport=function(){var e=0;var t=0;var r=0;switch(u.z){case 90:r=-1;break;case 180:e=-1;break;case 270:r=1;break}switch(u.x){case 90:t=1;break;case 180:e=-1;break;case 270:t=-1;break}if(u.x==0&&u.z==0){e=1}e=0;t=0;r=0;s.setAttribute("position",new THREE.Vector3(l.x+r,l.y+e,l.z+t));s.setAttribute("rotation",new THREE.Vector3(u.x,E,u.z));if(typeof c!="undefined"){c("arrived",d)}};r.tick=function(e,t){if(e-a>30){if(v!==false){r.updateTeleport()}a=e}};n()};var Exit=function(e){var t=this;var r=document.createElement("a-cylinder");r.setAttribute("color","#00ffff");r.setAttribute("scale","0.4 2 0.4");r.setAttribute("position","0 1 0");e.append(r);t.tick=function(e,t){}};var rotationSpeed=70;var Pad=function(g,e,t,r){var a=this;var o=false;var s=false;var l=false;var u=false;var n=false;var c=new THREE.Vector3(0,1,0);var f=r;var v=true;var i=t;var b=false;var p=false;var d=false;var E=false;var A=[];var y=false;var m=0;var T=null;var _=false;var h=false;var D=new THREE.Vector3;var w=new THREE.Vector3(0,0,-1);var R=false;var P=g_scene.object3D;var S=false;var V=false;var L=false;var I=0;var x=0;var M=0;var k=0;var O=0;var N=0;var H=false;var B=false;a.setClickable=function(e){if(!s){return}if(e){s.setAttribute("class","clickable")}else{s.setAttribute("class","")}};var C=function(){if(o===false){o=document.createElement("a-entity")}if(f!==BLOCKING_PAD){s=document.createElement("a-box");switch(f){case GREEN_PAD:s.setAttribute("color","#00aa00");break;case RED_PAD:s.setAttribute("color","#aa0000");break;default:s.setAttribute("color","#aaaaaa")}s.setAttribute("transparent",true);s.setAttribute("opacity","1");s.setAttribute("scale","1.2 0.02 1.2");s.setAttribute("position",new THREE.Vector3(0,-.01,0));s.addEventListener("mouseenter",q);s.addEventListener("mouseleave",F);s.addEventListener("mousedown",function(e){return;var t=false;if(e.detail){if(e.detail.cursorEl){t=e.detail.cursorEl}}if(g_scene==t){t=null}if(t){var r=t.getAttribute("position");console.log("position = ");console.log(r)}else{console.log("NO ORIGIN")}L=false;if(S){z();L=true}else{}});s.addEventListener("mouseup",function(e){});s.addEventListener("click",K);v=true;o.append(s)}u=document.createElement("a-box");switch(f){case GREEN_PAD:u.setAttribute("color","#00ee00");break;case RED_PAD:u.setAttribute("color","#ee0000");break;default:u.setAttribute("color","#eeeeee")}u.setAttribute("transparent",true);u.setAttribute("opacity","1");u.setAttribute("scale","1.6 0.2 1.6");u.setAttribute("position",new THREE.Vector3(0,-.12,0));u.setAttribute("class","clickable");o.append(u);if(f===PAD_WITH_ROBOT){p=document.createElement("a-entity");var e=new THREE.ConeGeometry(.4,1.8,4);d=new THREE.MeshStandardMaterial({color:16776960,transparent:true});d.flatShading=true;y=new THREE.Mesh(e,d);y.position.set(0,.9,0);p.setObject3D("mesh",y);var t=new THREE.ConeGeometry(.3,.6,3);var r=new THREE.Mesh(t,d);r.rotateX(-Math.PI/1.6);r.position.set(0,.8,-.2);y.add(r);T=new THREE.LineBasicMaterial({color:16711680,transparent:true});o.append(p);for(var a=0;a<12;a++){var n=[];n.push(new THREE.Vector3(0,0,0));n.push(new THREE.Vector3(0,10,0));var e=(new THREE.BufferGeometry).setFromPoints(n);var i=new THREE.Line(e,T);A.push({mesh:i,geometry:e});P.add(i)}S=true}return o};a.getObject=function(){return o.object3D};var j=function(){if(!S||p==null){return}var e=g_playfieldScale;var t=new THREE.Vector3;p.setAttribute("rotation","0 "+m+" 0");y.getWorldPosition(t);t.setY(t.y+1*e);var r=new THREE.Vector3;var a=g.getCollisionObjects();var n=6*e;var i=(m+90)*Math.PI/180;if(g.getGameState()==STATE_LEVEL_PREVIEW){i=(m-90)*Math.PI/180}H=false;for(var o=0;o<A.length;o++){var s=-o*5*Math.PI/180;var l=A[o].geometry.attributes.position.array;var u=0;l[u++]=t.x;l[u++]=t.y;l[u++]=t.z;var c=t.x+n*Math.cos(s);var f=t.y+n*Math.sin(s);var v=t.z;var d=c-t.x;c=t.x+d*Math.cos(-i);v=t.z+d*Math.sin(-i);r.setX(c-t.x);r.setY(f-t.y);r.setZ(v-t.z);r.normalize();g_raycaster.set(t,r);g_raycaster.near=0;g_raycaster.far=n;var E=g_raycaster.intersectObjects(a,true);if(E.length>0){c=E[0].point.x;f=E[0].point.y;v=E[0].point.z;if(typeof E[0].object.isPlayer!="undefined"){H=true;if(!B){B=true;g.decreasePlayerEnergy();g_sound.playSound(SOUND_REMOVE);_=b}}}l[u++]=c;l[u++]=f;l[u++]=v;A[o].geometry.attributes.position.needsUpdate=true;A[o].geometry.computeBoundingBox();A[o].geometry.computeBoundingSphere()}};a.getInAbsorb=function(){return V!==false};var z=function(){V=b;g.setEnergyTransferring(true)};var G=function(){V=false;g.setEnergyTransferring(false);if(d){d.opacity=1;T.opacity=1}};var U=function(){if(!S){return}S=false;V=false;g.setEnergyTransferring(false);o.removeChild(p);p=null;g.increasePlayerEnergy();for(var e=0;e<A.length;e++){P.remove(A[e].mesh);A[e].geometry.dispose()}A=[]};a.cleanup=function(){U()};var X=function(){if(i===g.getCurrentPadIndex()){return false}if(!g.getOnPad()){return false}var e=g.getPlayer().getPosition();var t=new THREE.Vector3(e.x-I,e.y-x,e.z-M);var r=t.length();return t.dot(c)>=0};var Y=function(){if(g.getGameState()==STATE_PLAYING&&X()){g_sound.playSound(SOUND_CLICK);switch(f){case GREEN_PAD:s.setAttribute("color","#8f8");break;case RED_PAD:s.setAttribute("color","#f88");break;default:s.setAttribute("color","#ffd")}}};var W=function(){R=false;if(s){switch(f){case GREEN_PAD:s.setAttribute("color","#0a0");break;case RED_PAD:s.setAttribute("color","#a00");break;default:s.setAttribute("color","#aaa")}}};var q=function(e){R=true;Y()};var F=function(e){R=false;W()};var K=function(e){};a.buttonDown=function(e){if(R){if(g.getGameState()==STATE_PLAYING){var t=false;if(e.detail){if(e.detail.cursorEl){t=e.detail.cursorEl}}if(g_scene==t){t=null}if(t){h=t}else{}L=false;if(S){z();L=true}else{}}if(g.getGameState()==STATE_PLAYING&&X()&&!S){g.teleportPlayer(I,x,M,k,N,i,f,function(){W()})}}};a.buttonUp=function(e){if(V!==false){G()}};a.playerTeleported=function(e,t){if(f===t&&i!==e&&f!==NORMAL_PAD){s.setAttribute("wireframe",true);u.setAttribute("wireframe",true);u.setAttribute("opacity",.4);u.setAttribute("class","");s.setAttribute("class","");v=false}else{s.setAttribute("wireframe",false);u.setAttribute("wireframe",false);u.setAttribute("opacity",1);u.setAttribute("class","clickable");s.setAttribute("class","clickable");v=true}B=false;W()};a.getIsSolid=function(){return v};a.getIndex=function(){return i};a.getEntity=function(){return o};a.setPosition=function(e,t,r){I=e;x=t;M=r;o.setAttribute("position",new THREE.Vector3(e,t,r))};a.setRotation=function(e,t,r){k=e;O=t;N=r;o.setAttribute("rotation",new THREE.Vector3(e,t,r));var a=0;var n=0;var i=0;switch(r){case 90:a=-1;break;case 180:n=-1;break;case 270:a=1;break}switch(e){case 90:i=1;break;case 180:n=-1;break;case 270:i=-1;break}c.set(a,n,i)};a.getPosition=function(){return o.getAttribute("position")};a.tick=function(e,t){if(S){if(V!==false){var r=e-V;if(l===false){l=new THREE.Vector3(0,0,0);s.object3D.getWorldPosition(l)}D.set(0,0,0);if(h){h.object3D.getWorldPosition(D)}else{var a=g.getPlayerPosition();D.set(a.x,a.y-.05,a.z)}g.setEnergyFromTo(l,D);if(r>2e3){U()}else{d.opacity=(1800-r)/1800;T.opacity=(1800-r)/1800}}if(B){var a=g.getPlayerPosition();var n=y.worldToLocal(a);n.setY(0);var i=w.angleTo(n);i=i*180/Math.PI;if(n.x<0){m+=i}else{m-=i}if(e-_>2e3){g.decreasePlayerEnergy();g_sound.playSound(SOUND_REMOVE);_=e}}else if(!H){m=(m+t/rotationSpeed)%360}j()}b=e};C()};g_sound=null;var SOUND_CLICK=1;var SOUND_EXIT=2;var SOUND_DIE=3;var SOUND_JUMP=4;var SOUND_FALL=5;var SOUND_GREEN=6;var SOUND_RED=7;var SOUND_REMOVE=8;var SOUND_PLACE=9;var SOUND_LEVEL_END=10;var Sound=function(){var l=null;this.init=function(){if(l==null){l=new AudioContext}};var u=function(e){return Math.pow(2,(e-69)/12)*440};this.playSound=function(e){if(l==null){return}var t=l.currentTime;var r=1/16;var a=1/64;var n=r;var i=l.createGain();var o=null;var s=null;o=l.createOscillator();o.type="square";o.connect(i);i.connect(l.destination);switch(e){case SOUND_REMOVE:r=1/32;o.type="triangle";o.frequency.setValueAtTime(u(69),t);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.3,l.currentTime+1/16);i.gain.linearRampToValueAtTime(0,l.currentTime+r*3);n=r*3;break;case SOUND_PLACE:case SOUND_CLICK:r=1/32;o.type="triangle";o.frequency.setValueAtTime(u(69),t);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.3,l.currentTime+1/128);i.gain.linearRampToValueAtTime(0,l.currentTime+r*3);n=r*3;break;case SOUND_FALL:r=1/4;o.type="triangle";o.frequency.setValueAtTime(u(62),t);o.frequency.linearRampToValueAtTime(u(55),t+r*4);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.3,l.currentTime+1/128);i.gain.linearRampToValueAtTime(0,l.currentTime+r*3);n=r*4;break;case SOUND_DIE:r=1/12;o.type="sawtooth";o.frequency.setValueAtTime(u(56),t);o.frequency.linearRampToValueAtTime(u(49),t+r);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.2,l.currentTime+r);i.gain.linearRampToValueAtTime(0,l.currentTime+r*2);n=r*2;break;case SOUND_JUMP:r=1/12;o.type="triangle";o.frequency.setValueAtTime(u(55),t);o.frequency.setValueAtTime(u(62),t+r);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.2,l.currentTime+1/64);i.gain.linearRampToValueAtTime(0,l.currentTime+r*2);n=r*2;break;case SOUND_GREEN:r=1/4;o.type="triangle";o.frequency.setValueAtTime(u(43),t);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.2,l.currentTime+1/32);i.gain.linearRampToValueAtTime(0,l.currentTime+r);n=r;break;case SOUND_RED:r=1/4;o.type="triangle";o.frequency.setValueAtTime(u(47),t);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.2,l.currentTime+1/32);i.gain.linearRampToValueAtTime(0,l.currentTime+r);n=r;break;case SOUND_EXIT:r=1/12;o.type="triangle";o.frequency.setValueAtTime(u(55),t);o.frequency.setValueAtTime(u(62),t+r);o.frequency.setValueAtTime(u(67),t+r*2);i.gain.setValueAtTime(0,t);i.gain.linearRampToValueAtTime(.3,l.currentTime+1/64);i.gain.linearRampToValueAtTime(0,l.currentTime+r*6);n=r*6;break}o.start(l.currentTime);o.stop(l.currentTime+n)}};var StartButton=function(e){var t=this;var r=document.getElementById("playfield-holder");var a=document.getElementById("start-button");var n=document.createElement("a-box");n.setAttribute("color","#00f");n.setAttribute("scale","0.05 0.15 1");n.setAttribute("position","0 0 0.3");n.setAttribute("class","clickable");n.setAttribute("visible",false);a.append(n);var i=document.createElement("a-triangle");i.setAttribute("color","#191");i.setAttribute("rotation","0 90 90");i.setAttribute("side","double");i.setAttribute("scale","0.15 0.18 0.15");a.append(i);r.append(a);n.addEventListener("click",function(){g_sound.init();g_sound.playSound(SOUND_CLICK);e.startLevel()});n.addEventListener("mouseenter",function(){i.setAttribute("color","#3f3");g_sound.playSound(SOUND_CLICK)});n.addEventListener("mouseleave",function(){i.setAttribute("color","#191")});t.hide=function(){n.setAttribute("class","");a.object3D.visible=false};t.show=function(){n.setAttribute("class","clickable");a.object3D.visible=true}};var START_PAD=1;var EXIT_PAD=2;var NORMAL_PAD=3;var PAD_WITH_ROBOT=4;var GREEN_PAD=5;var RED_PAD=6;var BLOCKING_PAD=7;var g_levels=[{text:["Level 1.","Select a pad to teleport to.","Each teleport will use one","unit of energy."],startRotation:0,energy:8,data:[[START_PAD,0,0,0,0,0,0],[NORMAL_PAD,0,.4,-6,0,0,0],[NORMAL_PAD,-2,1.1,-12,0,0,0],[NORMAL_PAD,2,1.1,-12,0,0,0],[EXIT_PAD,0,2,-18,0,0,0]]},{text:["Level 2.","If a robot sees you","it will drain your energy.",""],energy:8,robotSpeed:60,data:[[START_PAD,0,0,0,0,0,0],[PAD_WITH_ROBOT,-2.5,2.9,-7,0,0,0],[NORMAL_PAD,0,.5,-7,0,0,0],[NORMAL_PAD,0,1.5,-12,0,0,0],[PAD_WITH_ROBOT,2,2.9,-12,0,0,0],[EXIT_PAD,0,2.3,-20,0,0,0]]},{text:["Level 3.","You can absorb a robot's"," energy by selecting it's pad.",""],startRotation:0,energy:2,data:[[START_PAD,0,0,0,0,0,0],[NORMAL_PAD,2.5,-.5,-8,0,0,0],[PAD_WITH_ROBOT,-2.5,-.5,-8,0,0,0],[NORMAL_PAD,.5,4,-19,0,0,270],[EXIT_PAD,4,3.5,-17,0,0,0]]},{text:["Level 4.","When on a green pad,","other green pads will","disappear",""],data:[[START_PAD,0,0,0,0,0,0],[NORMAL_PAD,0,0,-4,270,0,0],[NORMAL_PAD,0,0,-4,270,0,0],[NORMAL_PAD,2,0,-5,0,0,0],[EXIT_PAD,1,.5,-20,0,0,0],[NORMAL_PAD,-5,1,-10,0,0,270],[NORMAL_PAD,-5,1,-15,0,0,0]],energy:2}];var english_voice="";var available_voices=window.speechSynthesis.getVoices();var utterance=false;function speak(e){if(!available_voices||available_voices.length==0){available_voices=window.speechSynthesis.getVoices()}if(english_voice==""){for(var t=0;t<available_voices.length;t++){if(available_voices[t].lang==="en-GB"){english_voice=available_voices[t];break}}if(english_voice===""&&available_voices.length>0){english_voice=available_voices[0]}}if(utterance){window.speechSynthesis.cancel(utterance)}utterance=new SpeechSynthesisUtterance;utterance.text=e;if(english_voice!=""){utterance.voice=english_voice}window.speechSynthesis.speak(utterance)}var InfoPanel=function(e){var t=this;var r=[];var a=document.createElement("a-entity");var n=document.createElement("a-plane");n.setAttribute("scale","1.2 1.8 1");n.setAttribute("color","#222");a.append(n);var i=document.createElement("a-text");i.setAttribute("value","Energy");i.setAttribute("position","-0.55 0.7 0");a.append(i);var o=[];for(var s=0;s<4;s++){o[s]=document.createElement("a-text");o[s].setAttribute("value","Info line 1 ");o[s].setAttribute("position",new THREE.Vector3(-.54,.15-.15*s,0));o[s].setAttribute("scale","0.4 0.4 0.4");o[s].setAttribute("anchor","left");a.append(o[s])}for(var s=0;s<8;s++){var l=document.createElement("a-plane");l.setAttribute("color","#0f0");l.setAttribute("scale","0.1 0.1 0.1");l.setAttribute("position",new THREE.Vector3(-.46+s*.12,.43,.02));r.push(l);a.append(l)}var u=document.createElement("a-plane");u.setAttribute("scale","0.1 0.1 0.1");u.setAttribute("position",new THREE.Vector3(-.46,-.76,.02));u.setAttribute("color","#111");a.append(u);e.append(a);t.setEnergy=function(e){if(e>=r.length){e=r.length}var t=0;for(t=0;t<e;t++){r[t].setAttribute("color","#0f0")}for(t=e;t<r.length;t++){r[t].setAttribute("color","#111")}};t.setButtonDown=function(e){if(e){u.setAttribute("color","#f90")}else{u.setAttribute("color","#111")}};t.setText=function(e,t){o[e].setAttribute("value",t)}};